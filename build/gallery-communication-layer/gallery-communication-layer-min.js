YUI.add("gallery-communication-layer",function(a){YUI.add("gallery-communication-layer",function(d,c){function b(e){c=c+": "+d.config.win.location.pathname;e=e||{};this._WIN=d.config.win;this._APPREADY="appready";this._BUFFER_TIMEOUT=e.bufferTimeout||10000;this._CALLBACK_TIMEOUT=e.callbackTimeout||10000;this._GUID=d.guid();this._proxyFor={};this._subscriptionFor={};this._PARENT_ORIGIN_ALIAS="parent";this._parentProxy=this._createEventProxy(this._PARENT_ORIGIN_ALIAS);if(e.debug){this._initDebugMode();}this._init();}b.prototype={_init:function(){this._initWindowMessageHandler();this._initParentConnection();},_initWindowMessageHandler:function(){this._addListener(this._WIN,"message",d.bind(function(j){var f,g,i;try{f=d.JSON.parse(j.data);}catch(h){}if(this._validateEventData(f)){i=this._createCLEventData(j,f);g=this._proxyRouter(j,f);if(g){g.fire(f.name,i);}}else{}},this));},_validateEventData:function(e){return !!(e&&e.name&&e.guid);},_proxyRouter:function(e,j){var h=j.name,g=j.guid,f=e.origin,i=null;if(this._proxyFor[h]){i=this._proxyFor[h];}else{if(this._proxyFor[g+f]){i=this._proxyFor[g+f];}else{}}return i;},_createCLEventData:function(e,f){var g={data:f.data,guid:f.guid,origin:e.origin,source:e.source};if(f.cbid){g.callback=d.bind(function(){this._postMessage(g.source,{name:f.cbid,guid:this._GUID,data:{args:d.Array(arguments)}},g.origin);},this);}return g;},_initParentConnection:function(){var f=this,h=f._WIN,e=h.location.href,g;if(h.parent==h){return;}if(e){g=f._getHandshakeToken(e);f._createEventProxy(g).once(g,function(i){f._deleteEventProxy(g);f._parentSource=i.source;f._parentOrigin=i.origin;f._parentGuid=i.guid;f._proxyFor[i.guid+i.origin]=f._parentProxy;f._parentProxy.fire(f._APPREADY);});f._postMessage(h.parent,{name:g,guid:f._GUID},"*");}},register:function(h,e){var f=this,i,g;h=d.one(h);i=h&&h.test("iframe")&&h.get("src");if(!i){return;}g=f._getHandshakeToken(i);f._createEventProxy(g).once(g,function(o){var j=o.origin,m=o.source,k=o.guid,l,n;if(d.Lang.isFunction(e)){l=f._createEventProxy(k+j);n=f._createCLProxy(l,{origin:j,source:m,guid:k});n.iframe=h;e(n);}f._deleteEventProxy(g);f._postMessage(m,{name:g,guid:f._GUID},j);});},_createCLProxy:function(h,j){var f=this,i=j.source,e=j.origin,g=j.guid;return{on:function(l,m){var k=d.Array(arguments);k.splice(1,1,function(n){if(e===n.origin){m(n);}});return h.on.apply(h,k);},once:function(l,m){var k=d.Array(arguments);k.splice(1,1,function(n){if(e===n.origin){m(n);}});return h.once.apply(h,k);},fire:function(l,m,k){f._fireWindowMessageEvent(l,i,e,{data:m,guid:g,callback:k});},open:function(l,k){return f._createConnectionObject(l,k,{guid:g,source:i,origin:e});},ready:function(k,l){return h.on(f._APPREADY,k,l);},purge:function(){d.Object.each(f._proxyFor,function(l,k){if(l===h){f._deleteEventProxy(k);}});h.detachAll();h=null;}};},ready:function(){this._fireParentMessageEvent(this._APPREADY);},on:function(f,g){var e=d.Array(arguments);e.unshift({once:false});return this._onParentMessageEvent.apply(this,e);},once:function(f,g){var e=d.Array(arguments);e.unshift({once:true});return this._onParentMessageEvent.apply(this,e);},fire:function(f,g,e){if(f){this._fireParentMessageEvent(f,g,e);}},open:function(f,e){if(this._parentAppIsReady()){return this._createConnectionObject(f,e,{guid:this._parentGuid,source:this._parentSource,origin:this._parentOrigin});}else{}},_createConnectionObject:function(h,e,j){var f=this,g,i;if(!(h&&d.Lang.isFunction(e)&&j.origin&&j.guid)){return null;}g=f._registerCallback(e,j.origin,j.guid,h);return{write:function(k){if(!f._subscriptionFor[h]){return;}f._fireWindowMessageEvent(h,j.source,j.origin,{data:k,guid:j.guid,callback:g});},close:function(){i=f._subscriptionFor[h];if(i){i.detach();delete f._subscriptionFor[h];}}};},_fireParentMessageEvent:function(g,j,e){var f=this,h,i;h=function(){f._fireWindowMessageEvent(g,f._parentSource,f._parentOrigin,{data:j,guid:f._parentGuid,callback:e});};if(!f._parentAppIsReady()){i=f._parentProxy.once(f._APPREADY,h);d.later(f._BUFFER_TIMEOUT,null,function(){if(!f._parentAppIsReady()){i.detach();}});}else{h();}},_parentAppIsReady:function(){var e=this._parentProxy.getEvent(this._APPREADY);return e.fired;},_getHandshakeToken:function(e){return e.replace(/[?].*$/,"").replace(/[#].*$/,"");},_registerCallback:function(h,m,k,f,l){var j=this._proxyFor[k+m],i=d.stamp(h),g,e;if(!j){return;}if(l){e=j.once(i,function(n){g.cancel();h.apply(null,n.data.args);});g=d.later(l,null,function(){e.detach();});}else{this._subscriptionFor[f]=j.on(i,function(n){h.apply(null,n.data.args);});}return i;},_createEventProxy:function(f){if(f){var e=new d.EventTarget();e.publish(this._APPREADY,{fireOnce:true});this._proxyFor[f]=e;return e;}},_deleteEventProxy:function(e){if(this._proxyFor[e]){this._proxyFor[e].detachAll();this._proxyFor[e]=null;}},_onParentMessageEvent:function(){var f=d.Array(arguments),e=f.shift(),h=e.once?"once":"on",g=this._parentProxy;return g[h].apply(g,f);},_fireWindowMessageEvent:function(g,h,f,j){var i,e;if(g&&h&&f){j=j||{};e=j.callback;i={name:g,guid:this._GUID};if(j.data){i.data=j.data;}if(d.Lang.isFunction(e)){i.cbid=this._registerCallback(e,f,j.guid,g,this._CALLBACK_TIMEOUT);}else{if(d.Lang.isString(e)){i.cbid=e;}}this._postMessage(h,i,f);}},_postMessage:function(f,g,e){if(f&&f.postMessage&&g&&e){f.postMessage(d.JSON.stringify(g),e);return true;}},_initDebugMode:function(){var e=this,f=e._createEventProxy("debug");YUI.CL={fire:function(g,h){f.fire(g,{data:h});},on:function(){return f.on.apply(f,arguments);},once:function(){return f.once.apply(f,arguments);}};d.Array.each(["fire","on","once"],function(g){var h=e[g];e[g]=function(){var i=d.Array(arguments);f[g].apply(f,i);h.apply(e,i);};});},_addListener:function(f,g,e){if(f.addEventListener){f.addEventListener(g,e,false);}else{if(f.attachEvent){f.attachEvent("on"+g,e);}else{f["on"+g]=e;}}},_removeListener:function(g,h,f){if(g.removeEventListener){try{g.removeEventListener(h,f);}catch(e){}}else{if(g&&g.detachEvent){g.detachEvent("on"+h,f);
}}}};d.CommunicationLayer=b;},"0.0.1",{requires:["json","node-base","event-custom-base"]});},"gallery-2012.06.20-20-07",{requires:["json","node-base","event-custom-base"],skinnable:false});