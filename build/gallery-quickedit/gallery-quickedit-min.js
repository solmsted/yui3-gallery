YUI.add("gallery-quickedit",function(b){function d(p){d.superclass.constructor.call(this,p);}d.NAME="QuickEditPlugin";d.NS="qe";d.ATTRS={changesAlwaysInclude:{value:[],validator:b.Lang.isArray}};var k=/quickedit-key:([^\s]+)/,i="quickedit-has",e=i+"([a-z]+)",h=new RegExp(b.Node.class_re_prefix+e+b.Node.class_re_suffix),m="quickedit-has",l=m+"([a-z]+)",j=new RegExp(b.Node.class_re_prefix+l+b.Node.class_re_suffix);d.error_text_class="quickedit-message-text";d.error_display_markup='<div class="quickedit-message-text"></div>';d.copy_down_button_class="quickedit-copy-down";d.textFormatter=function(r){var p='<input type="text" class="{yiv} quickedit-field quickedit-key:{key}" value="{value}"/>'+"{cd}"+d.error_display_markup;var q=r.column.quickEdit;return b.Lang.sub(p,{key:r.column.key,value:r.value.toString().replace(/"/g,"&quot;"),yiv:q.validation?(q.validation.css||""):"",cd:d.copyDownFormatter.call(this,r)});};d.textareaFormatter=function(r){var p='<textarea class="{yiv} quickedit-field quickedit-key:{key}">{value}</textarea>'+"{cd}"+d.error_display_markup;var q=r.column.quickEdit;return b.Lang.sub(p,{key:r.column.key,value:r.value,yiv:q.validation?(q.validation.css||""):"",cd:d.copyDownFormatter.call(this,r)});};d.readonlyEmailFormatter=function(p){return(p.value||"");};d.readonlyLinkFormatter=function(p){return(p.value||"");};function n(r,q){var t=null;this._tbodyNode.get("children").some(function(u){if(u.contains(r)){t=u;return true;}});if(!t){return null;}var p=r.getAncestorByTagName("td",true);var s=-1;t.get("children").some(function(v,u){if(v===p){s=u;return true;}});t=(q<0?t.previous():t.next());return t?t.get("children").item(s):null;}function f(s){var p=s.currentTarget.ancestor(".yui3-datatable-cell");var r=p.one(".quickedit-field");if(!r){return;}var q=b.Lang.trim(r.get("value"));if(!q&&q!==0){return;}while(1){p=n.call(this,p,+1);if(!p){break;}r=p.one(".quickedit-field");if(r){r.set("value",q);}}}d.copyDownFormatter=function(p,q){if(p.column.quickEdit.copyDown&&p.rowIndex===0){return b.Lang.sub('<button title="Copy down" class="{c}">&darr;</button>',{c:d.copy_down_button_class});}else{return"";}};function c(q,p){return function(r){if(!r.record&&b.Lang.isString(p)){return p;}else{return(r.record?q:p).apply(this,arguments);}};}function o(r){var p=n.call(this,r.target,r.charCode==38?-1:+1);if(p){var q=p.one(".quickedit-field");if(q){q.focus();q.select();r.halt(true);}}}function a(){var r=this.get("host").get("columns");var q={};function p(u,t){if(b.Lang.isString(t)){var s={key:t};u.push(s);q[t]=s;}else{if(t.children){u=b.reduce(t.children,u,p);}else{u.push(t);q[t.key]=t;}}return u;}this.column_list=b.reduce(r,[],p);this.column_map=q;}function g(v){var x=this.get("host");var r=true;var t=v.size();for(var s=0;s<t;s++){var u=v.item(s);var q=this.column_map[this._getColumnKey(u)].quickEdit;if(!q){continue;}var w=q.validation?q.validation.msg:null;var p=b.FormManager.validateFromCSSData(u,w);if(p.error){this.displayMessage(u,p.error,"error");r=false;continue;}if(p.keepGoing){if(q.validation&&q.validation.regex instanceof RegExp&&!q.validation.regex.test(u.get("value"))){this.displayMessage(u,w?w.regex:null,"error");r=false;continue;}}if(q.validation&&b.Lang.isFunction(q.validation.fn)&&!q.validation.fn.call(x,u)){r=false;continue;}}return r;}b.extend(d,b.Plugin.Base,{initializer:function(p){var r=this.get("host");this.hasMessages=false;a.call(this);this.get("host").after("columnsChange",a,this);var q=this.afterHostEvent("render",function(){r.get("boundingBox").delegate("click",f,"."+d.copy_down_button_class,r);q.detach();});},start:function(){this.fire("clearErrorNotification");var v=this.get("host");this.saveSort=[];this.saveEdit=[];this.saveFmt={};for(var t=0;t<this.column_list.length;t++){var r=this.column_list[t];var s=r.key;this.saveSort.push(r.sortable);r.sortable=false;var q=r.quickEdit;var w=r.qeFormatter;if(
/*!col.hidden &&*/
(q||w)){var u=null;if(q&&b.Lang.isFunction(q.formatter)){u=q.formatter;}else{if(b.Lang.isFunction(w)){u=w;}else{u=d.textFormatter;}}if(u){this.saveFmt[s]={formatter:r.formatter,nodeFormatter:r.nodeFormatter,allowHTML:r.allowHTML};r.formatter=c.call(this,u,r.formatter||r.nodeFormatter);r.nodeFormatter=null;r.allowHTML=true;}}}var p=v.get("contentBox");p.addClass(v.getClassName("quickedit"));this.move_event_handle=p.on("key",o,"down:38+ctrl,40+ctrl",v);v.set("columns",v.get("columns"));},cancel:function(){this.fire("clearErrorNotification");for(var r=0;r<this.column_list.length;r++){var q=this.column_list[r];q.sortable=this.saveSort[r];}delete this.saveSort;delete this.saveEdit;b.each(this.saveFmt,function(t,v){var u=this.column_map[v];u.formatter=t.formatter;u.nodeFormatter=t.nodeFormatter;u.allowHTML=t.allowHTML;},this);delete this.saveFmt;var s=this.get("host");var p=s.get("contentBox");p.removeClass(s.getClassName("quickedit"));if(this.move_event_handle){this.move_event_handle.detach();delete this.move_event_handle;}s.set("columns",s.get("columns"));},getChanges:function(){if(!this.validate()){return false;}var q=[];var p=this.get("changesAlwaysInclude");var r=this.get("host");var s=r._tbodyNode.get("children");r.get("data").each(function(w,y){var z=s.item(y).all(".quickedit-field");var A={};q.push(A);var B=z.size();for(var x=0;x<B;x++){var C=z.item(x);var D=this._getColumnKey(C);var v=this.column_map[D].quickEdit;var u=w.get(D);var t=b.Lang.trim(C.get("value"));if(v.changed?v.changed(u,t):t!==(u?u.toString():"")){A[D]=t;}}for(var x=0;x<p.length;x++){var D=p[x];A[D]=w.get(D);}},this);return q;},validate:function(){this.clearMessages();var p=true;var q=this.get("host");var t=q._tbodyNode.getElementsByTagName("input");var s=q._tbodyNode.getElementsByTagName("textarea");var r=q._tbodyNode.getElementsByTagName("select");p=g.call(this,t)&&p;p=g.call(this,s)&&p;p=g.call(this,r)&&p;if(!p){this.fire("notifyErrors");}return p;},clearMessages:function(){this.hasMessages=false;this.fire("clearErrorNotification");var p=this.get("host");p._tbodyNode.getElementsByClassName(e).removeClass(e);
p._tbodyNode.getElementsByClassName(l).removeClass(l);p._tbodyNode.all("."+d.error_text_class).set("innerHTML","");},displayMessage:function(s,u,r,q){if(b.Lang.isUndefined(q)){q=true;}s=b.one(s);var t=s.getAncestorByTagName("tr");if(b.FormManager.statusTakesPrecedence(this._getElementStatus(t,h),r)){if(!this.hasMessages&&q){b.one(t.get("firstChild")).scrollIntoView();}t.replaceClass(e,i+r);this.hasMessages=true;}var p=s.getAncestorByTagName("td");if(b.FormManager.statusTakesPrecedence(this._getElementStatus(p,j),r)){if(u){p.one("."+d.error_text_class).set("innerHTML",u);}p.replaceClass(l,m+r);this.hasMessages=true;}},_getElementStatus:function(s,q){var p=s.get("className").match(q);return((p&&p.length)?p[1]:false);},_getColumnKey:function(q){var p=k.exec(q.get("className"));return p[1];}});b.namespace("Plugin");b.Plugin.DataTableQuickEdit=d;},"gallery-2012.03.23-18-00",{skinnable:true,optional:["gallery-scrollintoview"],requires:["datatable-base","gallery-formmgr-css-validation","gallery-node-optimizations","gallery-funcprog"]});